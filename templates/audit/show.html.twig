{% extends 'base.html.twig' %}
{% import 'audit/_macros.html.twig' as macros %}

{% block title %}Audit {{ audit.url }} - {{ parent() }}{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    /* Modern design improvements */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        --card-shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.12);
    }

    /* Hero header card */
    .audit-hero-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .audit-hero-card .card-body {
        padding: 2rem;
    }

    .conformity-badge-large {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        font-size: 2rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .conformity-badge-large.success {
        background: rgba(40, 167, 69, 0.3);
        border-color: rgba(40, 167, 69, 0.5);
    }

    .conformity-badge-large.warning {
        background: rgba(255, 193, 7, 0.3);
        border-color: rgba(255, 193, 7, 0.5);
    }

    .conformity-badge-large.danger {
        background: rgba(220, 53, 69, 0.3);
        border-color: rgba(220, 53, 69, 0.5);
    }

    /* Modern stat cards */
    .stat-card-modern {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.05);
        height: 100%;
    }

    .stat-card-modern:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    .stat-card-modern .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-card-modern.critical .stat-icon {
        background: linear-gradient(135deg, #fa709a 0%, #dc3545 100%);
        color: white;
    }

    .stat-card-modern.major .stat-icon {
        background: linear-gradient(135deg, #ffa751 0%, #fd7e14 100%);
        color: white;
    }

    .stat-card-modern.minor .stat-icon {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .stat-card-modern.total .stat-icon {
        background: linear-gradient(135deg, #e0e0e0 0%, #6c757d 100%);
        color: white;
    }

    .stat-card-modern h2 {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }

    .stat-card-modern .stat-label {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.5rem;
    }

    .stat-card-modern .stat-sublabel {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .stat-card-modern .stat-value-minor {
        color: #667eea;
    }

    .stat-card-modern .stat-label-minor {
        color: #667eea;
    }

    /* Modern tabs */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 2rem;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 600;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
    }

    .nav-tabs .nav-link:hover {
        color: #667eea;
        border-bottom-color: #667eea;
        background: transparent;
    }

    .nav-tabs .nav-link.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: transparent;
    }

    .nav-tabs .nav-link i {
        margin-right: 0.5rem;
    }

    /* Modern cards */
    .card {
        border-radius: 12px;
        border: 1px solid #dee2e6;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        background: white;
    }

    .card:hover {
        box-shadow: var(--card-shadow-hover);
    }

    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-bottom: none;
        border-radius: 12px 12px 0 0 !important;
        padding: 1.25rem 1.5rem;
    }

    .card-header h5 {
        margin: 0;
        font-weight: 700;
        color: white;
    }

    .card-header i {
        color: white;
    }

    .card-body {
        background: white;
    }

    /* Dark mode support */
    [data-theme="dark"] .card {
        background: var(--card-bg) !important;
        border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .card-body {
        background: var(--card-bg) !important;
        color: var(--text-medium) !important;
    }

    [data-theme="dark"] .stat-card-modern {
        background: var(--card-bg) !important;
        border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .stat-card-modern h2 {
        color: inherit !important;
    }

    [data-theme="dark"] .stat-sublabel {
        color: var(--text-light) !important;
    }

    /* Hero card specific styles */
    .audit-hero-card .hero-icon {
        font-size: 1.5rem;
        margin-right: 0.75rem;
    }

    .audit-hero-card .hero-title {
        font-weight: 700;
        margin-bottom: 0;
    }

    .audit-hero-card .hero-url {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
    }

    .audit-hero-card .hero-url a {
        color: white;
        text-decoration: none;
    }

    .audit-hero-card .hero-url a:hover {
        text-decoration: underline;
    }

    .audit-hero-card .hero-date {
        opacity: 0.9;
        font-size: 0.95rem;
        margin-bottom: 0;
    }

    .conformity-badge-large .conformity-icon {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 0.5rem;
    }

    .conformity-badge-large .conformity-percentage {
        font-size: 3rem;
        line-height: 1;
    }

    .conformity-badge-large .conformity-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 0.5rem;
    }

    .issues-total-badge .issues-number {
        font-size: 3rem;
        font-weight: 700;
        line-height: 1;
    }

    .issues-total-badge .issues-label {
        font-size: 0.9rem;
        opacity: 0.9;
        margin-top: 0.5rem;
    }

    /* Modern accordions */
    .accordion-item {
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 8px !important;
        margin-bottom: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        background: white;
    }

    .accordion-button {
        background: white;
        font-weight: 600;
        padding: 1rem 1.25rem;
        border-radius: 8px !important;
        color: #212529;
    }

    .accordion-button:not(.collapsed) {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #667eea;
        box-shadow: none;
    }

    .accordion-button:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .accordion-button::after {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23667eea'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
    }

    .accordion-body {
        max-height: 600px;
        overflow-y: auto;
        padding: 1.25rem;
        background: #fafbfc;
    }

    /* Dark mode for accordions */
    [data-theme="dark"] .accordion-item {
        background: var(--bg-light) !important;
        border-color: var(--border-color) !important;
    }

    [data-theme="dark"] .accordion-button {
        background: var(--bg-light) !important;
        color: var(--text-dark) !important;
    }

    [data-theme="dark"] .accordion-button:not(.collapsed) {
        background: var(--bg-white) !important;
        color: var(--info-color) !important;
    }

    [data-theme="dark"] .accordion-body {
        background: var(--card-bg) !important;
        color: var(--text-medium) !important;
    }

    /* Severity badges enhanced */
    .severity-critical, .badge.severity-critical {
        background: linear-gradient(135deg, #fa709a 0%, #dc3545 100%) !important;
        color: white !important;
        font-weight: 600;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    .severity-major, .badge.severity-major {
        background: linear-gradient(135deg, #ffa751 0%, #fd7e14 100%) !important;
        color: white !important;
        font-weight: 600;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    .severity-minor, .badge.severity-minor {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        font-weight: 600;
        padding: 0.35rem 0.75rem;
        border-radius: 6px;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
    }

    /* Priority badges */
    .priority-issue-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 8px;
    }
    .priority-issue-card:hover {
        transform: translateX(5px);
        box-shadow: var(--card-shadow-hover);
    }
    .priority-1 { border-left-color: #dc3545; }
    .priority-2 { border-left-color: #fd7e14; }
    .priority-3 { border-left-color: #0dcaf0; }
    .priority-4 { border-left-color: #6c757d; }

    /* Responsive improvements */
    @media (max-width: 767.98px) {
        /* Page header - stack title and buttons */
        .audit-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem;
        }

        .audit-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .audit-header .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        /* URL info card - stack elements */
        .audit-url-info {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .audit-url-info > div:last-child {
            margin-top: 1rem;
            width: 100%;
            text-align: left !important;
        }

        /* Priority statistics cards - add margin */
        .priority-stats-row .col-md-3 {
            margin-bottom: 1rem;
        }

        .priority-stats-row .col-md-3:last-child {
            margin-bottom: 0;
        }

        /* Issue cards - wrap badges and adjust layout */
        .priority-issue-card .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .priority-issue-card .badge {
            margin-bottom: 0.25rem;
        }

        .priority-issue-card .text-end {
            text-align: left !important;
            margin-top: 0.5rem;
        }

        /* Statistics cards - add margin */
        .stats-row .col-md-3 {
            margin-bottom: 1rem;
        }

        .stats-row .col-md-3:last-child {
            margin-bottom: 0;
        }

        /* Nav tabs - smaller font */
        .nav-tabs .nav-link {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }

        .nav-tabs .nav-link i {
            display: none;
        }

        /* Accordion buttons - adjust text size */
        .accordion-button {
            font-size: 0.875rem;
            padding: 0.75rem;
        }

        .accordion-button .badge {
            font-size: 0.75rem;
            margin-left: 0.25rem !important;
            margin-top: 0.25rem;
        }

        /* RGAA Grid - make table scrollable */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-responsive table {
            min-width: 600px;
        }

        /* Alert boxes - reduce padding */
        .alert {
            padding: 0.75rem;
        }

        .alert small {
            font-size: 0.813rem;
        }

        /* Card spacing */
        .card {
            margin-bottom: 1rem;
        }
    }

    /* Tablet adjustments */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .audit-header h1 {
            font-size: 1.75rem;
        }

        /* 2 columns for priority stats on tablet */
        .priority-stats-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }

        .stats-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }

        .source-count-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 audit-header">
    <h1><i class="bi bi-file-earmark-text"></i> R√©sultats de l'audit</h1>
    <div>
        <a href="{{ path('app_export_audit_pdf', {id: audit.id}) }}" class="btn btn-success">
            <i class="bi bi-file-pdf"></i> Exporter PDF
        </a>
        <a href="{{ path('app_export_audit_excel', {id: audit.id}) }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Exporter Excel
        </a>
        <a href="{{ path('app_export_audit_csv', {id: audit.id}) }}" class="btn btn-primary">
            <i class="bi bi-filetype-csv"></i> Exporter CSV
        </a>
        <a href="{{ path('app_campaign_show', {id: audit.campaign.id}) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour √† la campagne
        </a>
    </div>
</div>

{# Modern hero header card #}
<div class="card audit-hero-card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center audit-url-info flex-wrap">
            <div class="flex-grow-1 mb-3 mb-md-0">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-globe2 hero-icon"></i>
                    <h4 class="hero-title">URL audit√©e</h4>
                </div>
                <p class="hero-url mb-2">
                    <a href="{{ audit.url }}" target="_blank" class="text-break">
                        <i class="bi bi-box-arrow-up-right me-1"></i>{{ audit.url }}
                    </a>
                </p>
                <p class="hero-date">
                    <i class="bi bi-calendar3"></i> Audit r√©alis√© le {{ audit.createdAt|date('d/m/Y √† H:i') }}
                </p>
            </div>
            <div class="d-flex gap-3 align-items-center flex-wrap">
                {% if audit.conformityRate is not null %}
                    {% set rate = audit.conformityRate|number_format(1) %}
                    {% if rate >= 90 %}
                        <div class="conformity-badge-large success text-center">
                            <i class="bi bi-check-circle-fill conformity-icon"></i>
                            <div class="conformity-percentage">{{ rate }}%</div>
                            <div class="conformity-label">CONFORME</div>
                        </div>
                    {% elseif rate >= 70 %}
                        <div class="conformity-badge-large text-center">
                            <i class="bi bi-info-circle-fill conformity-icon"></i>
                            <div class="conformity-percentage">{{ rate }}%</div>
                            <div class="conformity-label">PARTIELLEMENT CONFORME</div>
                        </div>
                    {% elseif rate >= 50 %}
                        <div class="conformity-badge-large warning text-center">
                            <i class="bi bi-exclamation-triangle-fill conformity-icon"></i>
                            <div class="conformity-percentage">{{ rate }}%</div>
                            <div class="conformity-label">√Ä AM√âLIORER</div>
                        </div>
                    {% else %}
                        <div class="conformity-badge-large danger text-center">
                            <i class="bi bi-x-circle-fill conformity-icon"></i>
                            <div class="conformity-percentage">{{ rate }}%</div>
                            <div class="conformity-label">NON CONFORME</div>
                        </div>
                    {% endif %}
                {% endif %}
                <div class="issues-total-badge text-center">
                    <div class="issues-number">{{ audit.totalIssues }}</div>
                    <div class="issues-label">
                        PROBL√àME{% if audit.totalIssues > 1 %}S{% endif %}<br>D√âTECT√â{% if audit.totalIssues > 1 %}S{% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if audit.status == 'running' %}
    <div class="alert alert-info">
        <i class="bi bi-hourglass-split"></i> L'audit est en cours d'ex√©cution...
        <div class="progress mt-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-full" role="progressbar"></div>
        </div>
    </div>
{% elseif audit.status == 'failed' %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> L'audit a √©chou√© : {{ audit.errorMessage }}
    </div>
{% else %}

{# Navigation par onglets #}
<ul class="nav nav-tabs mb-4" id="auditTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
            <i class="bi bi-bar-chart-fill"></i> Vue d'ensemble
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid" type="button" role="tab" aria-controls="grid" aria-selected="false">
            <i class="bi bi-clipboard-check"></i> Grille RGAA (106 crit√®res)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">
            <i class="bi bi-list-check"></i> D√©tail des probl√®mes
        </button>
    </li>
</ul>

<div class="tab-content" id="auditTabsContent">
    {# Tab 1 : Vue d'ensemble #}
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">

{# Summary text block - moved to top #}
{% if summary_text %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-card-text"></i> R√©sum√© de l'audit</h5>
    </div>
    <div class="card-body">
        <div class="text-muted">{{ summary_text }}</div>
    </div>
</div>
{% endif %}

<div class="row mb-4 stats-row">
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="stat-card-modern critical">
            <div class="stat-icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <h2 class="text-danger">{{ audit.criticalCount }}</h2>
            <div class="stat-label text-danger">Critiques</div>
            <div class="stat-sublabel">Bloquent l'acc√®s au contenu</div>
        </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="stat-card-modern major">
            <div class="stat-icon">
                <i class="bi bi-exclamation-circle-fill"></i>
            </div>
            <h2 class="text-warning">{{ audit.majorCount }}</h2>
            <div class="stat-label text-warning">Majeurs</div>
            <div class="stat-sublabel">G√™nent fortement l'utilisation</div>
        </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="stat-card-modern minor">
            <div class="stat-icon">
                <i class="bi bi-info-circle-fill"></i>
            </div>
            <h2 class="stat-value-minor">{{ audit.minorCount }}</h2>
            <div class="stat-label stat-label-minor">Mineurs</div>
            <div class="stat-sublabel">Am√©liorations recommand√©es</div>
        </div>
    </div>
    <div class="col-md-3 mb-3 mb-md-0">
        <div class="stat-card-modern total">
            <div class="stat-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <h2 class="text-secondary">{{ audit.totalIssues }}</h2>
            <div class="stat-label text-secondary">Total</div>
            <div class="stat-sublabel">Tous les probl√®mes d√©tect√©s</div>
        </div>
    </div>
</div>

{# Non-conform RGAA criteria card #}
{% if non_conform_details is defined and non_conform_details|length > 0 %}
<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-x-circle"></i> Crit√®res RGAA non-conformes
            <span class="badge bg-white text-danger ms-2">
                {{ non_conform_details|length }} non-conforme{% if non_conform_details|length > 1 %}s{% endif %}
                {% if audit.conformCriteria is not null and audit.nonConformCriteria is not null %}
                    / {{ audit.conformCriteria + audit.nonConformCriteria }} test√©s
                {% endif %}
                (sur 106 crit√®res RGAA)
            </span>
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <strong><i class="bi bi-info-circle"></i> R√©sum√© des tests :</strong>
            <div class="row mt-2 text-center">
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-success mb-0">{{ audit.conformCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res conformes<br>(aucune erreur)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-danger mb-0">{{ audit.nonConformCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res non-conformes<br>(avec erreurs)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-secondary mb-0">{{ audit.notApplicableCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res non test√©s<br>(tests manuels requis)</small>
                    </div>
                </div>
            </div>
        </div>
        <p class="text-muted mb-3">
            Chaque crit√®re non-conforme peut g√©n√©rer plusieurs erreurs individuelles.
            Cliquez sur un crit√®re ci-dessous pour voir les d√©tails des probl√®mes.
        </p>
        <div class="accordion" id="nonConformAccordion">
            {% for detail in non_conform_details %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button {% if loop.index > 3 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.index <= 3 %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                        <span class="badge bg-danger me-2">RGAA {{ detail.criteriaNumber }}</span>
                        <strong>{{ detail.criteriaTitle }}</strong>
                        <span class="badge bg-secondary ms-auto">{{ detail.errorCount }} erreur{% if detail.errorCount > 1 %}s{% endif %}</span>
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.index <= 3 %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#nonConformAccordion">
                    <div class="accordion-body">
                        <div style="white-space: pre-line;">{{ detail.reason }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}



{# MASQU√â : Les statistiques RGAA automatiques ne sont pas fiables
   - Seuls ~40 crit√®res sur 106 sont testables automatiquement
   - Les autres n√©cessitent une validation manuelle
   - Ces chiffres seraient trompeurs pour l'utilisateur
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Statistiques RGAA (106 crit√®res)</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h3 class="text-success">{{ audit.conformCriteria }}</h3>
                <p class="text-muted">Conformes</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-danger">{{ audit.nonConformCriteria }}</h3>
                <p class="text-muted">Non conformes</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-secondary">{{ audit.notApplicableCriteria }}</h3>
                <p class="text-muted">Non applicables</p>
            </div>
        </div>
        <div class="chart-container mt-4">
            <canvas id="criteriaChart"></canvas>
        </div>
    </div>
</div>
#}

    </div>
    {# End Tab 1: Vue d'ensemble #}

    {# Tab 2: Grille RGAA compl√®te #}
    <div class="tab-pane fade" id="grid" role="tabpanel" aria-labelledby="grid-tab">

{# Vue compl√®te des 106 crit√®res RGAA #}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Grille compl√®te RGAA 4.1 (106 crit√®res)</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            Cette grille affiche tous les crit√®res RGAA et leur statut de v√©rification :
        </p>
        <div class="row mb-3">
            <div class="col-md-3">
                <span class="badge bg-success me-1">‚úì</span> <small>Test√© automatiquement + conforme</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-danger me-1">‚úó</span> <small>Test√© automatiquement + erreurs d√©tect√©es</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning me-1">‚ö†</span> <small>Non test√© (√©l√©ment absent ou v√©rification manuelle requise)</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-secondary me-1">‚ûñ</span> <small>Non v√©rifi√©</small>
            </div>
        </div>

        <div class="accordion" id="rgaaFullGridAccordion">
            {% for topic, criteria_list in criteria_by_topic %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTopic{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTopic{{ loop.index }}" aria-expanded="false" aria-controls="collapseTopic{{ loop.index }}">
                        <strong>{{ topic }}</strong>
                        <span class="ms-2 text-muted">({{ criteria_list|length }} crit√®res)</span>
                    </button>
                </h2>
                <div id="collapseTopic{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="headingTopic{{ loop.index }}" data-bs-parent="#rgaaFullGridAccordion">
                    <div class="accordion-body accordion-body-scroll">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th class="col-criteria-number">Crit√®re</th>
                                    <th class="col-criteria-level">Niveau</th>
                                    <th class="col-criteria-description">Description</th>
                                    <th class="col-criteria-status">Statut / V√©rification</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for criteria in criteria_list %}
                                <tr class="{% if not criteria.autoTestable %}manual-check-row{% endif %}" data-criteria="{{ criteria.number }}">
                                    <td><strong>{{ criteria.number }}</strong></td>
                                    <td><span class="badge bg-info">{{ criteria.level }}</span></td>
                                    <td>
                                        {{ criteria.description }}
                                        {% if not criteria.autoTestable %}
                                            <div class="mt-2">
                                                <textarea class="form-control form-control-sm manual-check-notes" placeholder="üí° Notes de v√©rification (optionnel)" rows="2" data-criteria="{{ criteria.number }}"></textarea>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if criteria.autoTestable %}
                                            {# Crit√®res test√©s automatiquement - affichage en lecture seule #}
                                            {% if criteria.number in criteria_status.conform %}
                                                <span class="badge bg-success" title="Test√© automatiquement et conforme">‚úì Conforme (auto)</span>
                                            {% elseif criteria.number in criteria_status.nonConform %}
                                                <span class="badge bg-danger" title="Test√© automatiquement et non conforme">‚úó Non conforme (auto)</span>
                                            {% else %}
                                                <span class="badge bg-warning" title="Crit√®re testable automatiquement mais non v√©rifi√© sur cette page">‚ö† Non test√© (auto)</span>
                                            {% endif %}
                                        {% else %}
                                            {# Crit√®res manuels - boutons radio interactifs #}
                                            <div class="btn-group-vertical w-100" role="group">
                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="conform_{{ criteria.number|replace({'.': '_'}) }}" value="conform" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-success" for="conform_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-check-circle"></i> Conforme
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="nonconform_{{ criteria.number|replace({'.': '_'}) }}" value="non_conform" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-danger" for="nonconform_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-x-circle"></i> Non conforme
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="notapplicable_{{ criteria.number|replace({'.': '_'}) }}" value="not_applicable" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-secondary" for="notapplicable_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-dash-circle"></i> Non applicable
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="notchecked_{{ criteria.number|replace({'.': '_'}) }}" value="not_checked" autocomplete="off" checked>
                                                <label class="btn btn-sm btn-outline-secondary" for="notchecked_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-circle"></i> Non v√©rifi√©
                                                </label>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-3 alert alert-info">
            <h6><i class="bi bi-lightbulb"></i> Comment utiliser cette grille :</h6>
            <ul class="mb-0">
                <li><strong>Crit√®res avec badge vert/rouge "auto"</strong> : Test√©s automatiquement par les outils. Aucune action requise.</li>
                <li><strong>Crit√®res avec boutons radio</strong> : N√©cessitent une v√©rification manuelle. S√©lectionnez "Conforme" ou "Non conforme" apr√®s avoir v√©rifi√© le site.</li>
                <li><strong>Notes</strong> : Vous pouvez ajouter des observations pour chaque crit√®re manuel. Elles sont sauvegard√©es automatiquement.</li>
            </ul>
        </div>
    </div>
</div>

    </div>
    {# End Tab 2: Grille RGAA #}

    {# Tab 3: D√©tail des probl√®mes #}
    <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> D√©tail des probl√®mes d√©tect√©s</h5>
    </div>
    <div class="card-body">
        {% if grouped_by_theme|length > 0 %}
        {% for key, theme in grouped_by_theme %}
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header theme-card-header" style="background-color: {{ theme.theme_color }}15; border-left-color: {{ theme.theme_color }};">
                <h4 class="mb-0">
                    <i class="{{ theme.theme_icon }}" style="color: {{ theme.theme_color }};"></i>
                    <strong>Th√®me {{ theme.theme_number }}</strong> : {{ theme.theme_name }}
                    <span class="badge bg-secondary ms-2">{{ theme.total_count }} probl√®me(s)</span>
                </h4>
            </div>
            <div class="card-body">
                {% for criterion_key, criterion_data in theme.criteria %}
                {% set safe_criterion_key = criterion_key|replace({'.': '_', ',': '_', ' ': '_', ':': '_'}) %}
                <div class="mb-4">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-bookmark-check" style="color: {{ theme.theme_color }};"></i>
                        Crit√®re <strong>{{ criterion_data.criterion }}</strong>{% if criterion_data.criterion_description and criterion_data.criterion_description != '' %} - {{ criterion_data.criterion_description }}{% endif %}
                        <span class="badge bg-secondary ms-2">{{ criterion_data.total_count }}</span>
                    </h5>

                {% if criterion_data.results.critical|length > 0 %}
                <h6 class="mt-2"><span class="badge severity-critical">Probl√®mes critiques ({{ criterion_data.results.critical|length }} types)</span></h6>
                <div class="accordion mb-3" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_critical">
                    {{ macros.issueAccordion(criterion_data.results.critical, 'critical', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_critical') }}
                </div>
                {% endif %}

                {% if criterion_data.results.major|length > 0 %}
                <h6 class="mt-3"><span class="badge severity-major">Probl√®mes majeurs ({{ criterion_data.results.major|length }} types)</span></h6>
                <div class="accordion mb-3" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_major">
                    {{ macros.issueAccordion(criterion_data.results.major, 'major', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_major') }}
                </div>
                {% endif %}

                {% if criterion_data.results.minor|length > 0 %}
                <h6 class="mt-3"><span class="badge severity-minor">Probl√®mes mineurs ({{ criterion_data.results.minor|length }} types)</span></h6>
                <div class="accordion" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_minor">
                    {{ macros.issueAccordion(criterion_data.results.minor, 'minor', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_minor') }}
                </div>
                {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> Aucun probl√®me d√©tect√© !
        </div>
        {% endif %}
    </div>
</div>

    </div>
    {# End Tab 3: D√©tail des probl√®mes #}

</div>
{# End tab-content #}

{% endif %}
{% endblock %}

{% block javascripts %}
{% if audit.status == 'completed' %}
<script>
// Manual checks JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const auditId = {{ audit.id }};
    const manualChecks = {{ manual_checks|json_encode|raw }};
    const criteriaByTopic = {{ criteria_by_topic|json_encode|raw }};
    const criteriaStatus = {{ criteria_status|json_encode|raw }};

    // Load existing checks
    Object.keys(manualChecks).forEach(criteriaNumber => {
        const check = manualChecks[criteriaNumber];
        const safeNumber = criteriaNumber.replace(/\./g, '_');

        // Set radio button
        const radioButton = document.querySelector(`input[name="check_${safeNumber}"][value="${check.status}"]`);
        if (radioButton) {
            radioButton.checked = true;
        }

        // Set notes
        const notesTextarea = document.querySelector(`.manual-check-notes[data-criteria="${criteriaNumber}"]`);
        if (notesTextarea && check.notes) {
            notesTextarea.value = check.notes;
        }
    });

    // Save function
    function saveManualCheck(criteriaNumber, status, notes) {
        console.log('saveManualCheck called:', { criteriaNumber, status, notes });

        // Update local manualChecks object
        manualChecks[criteriaNumber] = { status: status, notes: notes };

        // Update table immediately (optimistic update)
        updateCriteriaStatusTable();

        // Save to server
        fetch(`/manual-check/save/${auditId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                criteriaNumber: criteriaNumber,
                status: status,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Saved:', criteriaNumber, status);
                showToast('‚úì V√©rification sauvegard√©e', 'success');
            } else {
                showToast('‚úó Erreur de sauvegarde', 'danger');
                // Revert on error (optional - you could reload instead)
                delete manualChecks[criteriaNumber];
                updateCriteriaStatusTable();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('‚úó Erreur de sauvegarde', 'danger');
            // Revert on error
            delete manualChecks[criteriaNumber];
            updateCriteriaStatusTable();
        });
    }

    // Toast notification
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        document.body.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement.querySelector('.toast'));
        toast.show();
        setTimeout(() => toastElement.remove(), 4000);
    }

    // Update criteria status table in real-time
    function updateCriteriaStatusTable() {
        let totalConform = 0;
        let totalNonConform = 0;
        let totalNotApplicable = 0;
        let totalNotTested = 0;

        // Get current table rows (excluding header and footer)
        const table = document.getElementById('criteria-status-table');
        if (!table) {
            console.error('Table #criteria-status-table not found');
            return;
        }
        const tableBody = table.querySelector('tbody');
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach((row, index) => {
            const topicName = Object.keys(criteriaByTopic)[index];
            const topicCriteria = criteriaByTopic[topicName];

            let conformCount = 0;
            let nonConformCount = 0;
            let notApplicableCount = 0;
            let notTestedCount = 0;

            topicCriteria.forEach(criterion => {
                const criterionNumber = criterion.number;

                // Priority 1: Check if not applicable (from manual checks)
                if (manualChecks[criterionNumber] && manualChecks[criterionNumber].status === 'not_applicable') {
                    notApplicableCount++;
                }
                // Priority 2: Check if non-conform (from automatic tests)
                else if (criteriaStatus.nonConform && criteriaStatus.nonConform.includes(criterionNumber)) {
                    nonConformCount++;
                }
                // Priority 3: Check if conform (from automatic tests OR manual checks)
                else if ((criteriaStatus.conform && criteriaStatus.conform.includes(criterionNumber)) ||
                         (manualChecks[criterionNumber] && manualChecks[criterionNumber].status === 'conform')) {
                    conformCount++;
                }
                // Priority 4: Not tested yet
                else {
                    notTestedCount++;
                }
            });

            // Update row badges
            row.children[1].querySelector('.badge').textContent = conformCount;
            row.children[2].querySelector('.badge').textContent = nonConformCount;
            row.children[3].querySelector('.badge').textContent = notTestedCount;
            row.children[4].querySelector('.badge').textContent = notApplicableCount;

            // Add to totals
            totalConform += conformCount;
            totalNonConform += nonConformCount;
            totalNotApplicable += notApplicableCount;
            totalNotTested += notTestedCount;
        });

        // Update footer totals
        const footerRow = table.querySelector('tfoot tr');
        footerRow.children[1].querySelector('.badge').textContent = totalConform;
        footerRow.children[2].querySelector('.badge').textContent = totalNonConform;
        footerRow.children[3].querySelector('.badge').textContent = totalNotTested;
        footerRow.children[4].querySelector('.badge').textContent = totalNotApplicable;

        console.log('Table updated:', { totalConform, totalNonConform, totalNotTested, totalNotApplicable });
    }

    // Listen to radio buttons
    document.querySelectorAll('input[type="radio"][name^="check_"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const row = this.closest('tr.manual-check-row');
            const criteriaNumber = row.dataset.criteria;
            const status = this.value;
            const notesElement = document.querySelector(`.manual-check-notes[data-criteria="${criteriaNumber}"]`);
            const notes = notesElement ? notesElement.value : '';

            saveManualCheck(criteriaNumber, status, notes);
        });
    });

    // Listen to notes textarea (debounced)
    let noteTimeout;
    document.querySelectorAll('.manual-check-notes').forEach(textarea => {
        textarea.addEventListener('input', function() {
            clearTimeout(noteTimeout);
            noteTimeout = setTimeout(() => {
                const criteriaNumber = this.dataset.criteria;
                const safeNumber = criteriaNumber.replace(/\./g, '_');
                const radioButton = document.querySelector(`input[name="check_${safeNumber}"]:checked`);
                const status = radioButton ? radioButton.value : 'not_checked';
                const notes = this.value;

                saveManualCheck(criteriaNumber, status, notes);
            }, 1000); // Wait 1s after user stops typing
        });
    });
});
</script>
{% endif %}
{% endblock %}
