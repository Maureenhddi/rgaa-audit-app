{% extends 'base.html.twig' %}
{% import 'audit/_macros.html.twig' as macros %}

{% block title %}Audit {{ audit.url }} - {{ parent() }}{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .accordion-body {
        max-height: 500px;
        overflow-y: auto;
    }
    .priority-issue-card {
        border-left: 4px solid;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .priority-issue-card:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .priority-1 { border-left-color: #dc3545; }
    .priority-2 { border-left-color: #fd7e14; }
    .priority-3 { border-left-color: #0dcaf0; }
    .priority-4 { border-left-color: #6c757d; }

    /* Responsive improvements */
    @media (max-width: 767.98px) {
        /* Page header - stack title and buttons */
        .audit-header {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 1rem;
        }

        .audit-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .audit-header .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        /* URL info card - stack elements */
        .audit-url-info {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .audit-url-info > div:last-child {
            margin-top: 1rem;
            width: 100%;
            text-align: left !important;
        }

        /* Priority statistics cards - add margin */
        .priority-stats-row .col-md-3 {
            margin-bottom: 1rem;
        }

        .priority-stats-row .col-md-3:last-child {
            margin-bottom: 0;
        }

        /* Issue cards - wrap badges and adjust layout */
        .priority-issue-card .d-flex {
            flex-direction: column !important;
            align-items: flex-start !important;
        }

        .priority-issue-card .badge {
            margin-bottom: 0.25rem;
        }

        .priority-issue-card .text-end {
            text-align: left !important;
            margin-top: 0.5rem;
        }

        /* Statistics cards - add margin */
        .stats-row .col-md-3 {
            margin-bottom: 1rem;
        }

        .stats-row .col-md-3:last-child {
            margin-bottom: 0;
        }

        /* Nav tabs - smaller font */
        .nav-tabs .nav-link {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }

        .nav-tabs .nav-link i {
            display: none;
        }

        /* Accordion buttons - adjust text size */
        .accordion-button {
            font-size: 0.875rem;
            padding: 0.75rem;
        }

        .accordion-button .badge {
            font-size: 0.75rem;
            margin-left: 0.25rem !important;
            margin-top: 0.25rem;
        }

        /* RGAA Grid - make table scrollable */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-responsive table {
            min-width: 600px;
        }

        /* Alert boxes - reduce padding */
        .alert {
            padding: 0.75rem;
        }

        .alert small {
            font-size: 0.813rem;
        }

        /* Card spacing */
        .card {
            margin-bottom: 1rem;
        }
    }

    /* Tablet adjustments */
    @media (min-width: 768px) and (max-width: 991.98px) {
        .audit-header h1 {
            font-size: 1.75rem;
        }

        /* 2 columns for priority stats on tablet */
        .priority-stats-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }

        .stats-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }

        .source-count-row .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 audit-header">
    <h1><i class="bi bi-file-earmark-text"></i> R√©sultats de l'audit</h1>
    <div>
        <a href="{{ path('app_export_audit_pdf', {id: audit.id}) }}" class="btn btn-success">
            <i class="bi bi-file-pdf"></i> Exporter PDF
        </a>
        <a href="{{ path('app_export_audit_excel', {id: audit.id}) }}" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Exporter Excel
        </a>
        <a href="{{ path('app_export_audit_csv', {id: audit.id}) }}" class="btn btn-primary">
            <i class="bi bi-filetype-csv"></i> Exporter CSV
        </a>
        <a href="{{ path('app_audit_list') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Retour
        </a>
    </div>
</div>

{# Simple header with URL and date only #}
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center audit-url-info">
            <div class="flex-grow-1">
                <h5 class="mb-2">URL audit√©e</h5>
                <p class="mb-1"><a href="{{ audit.url }}" target="_blank" class="text-break">{{ audit.url }}</a></p>
                <p class="text-muted mb-0">
                    <i class="bi bi-calendar"></i> {{ audit.createdAt|date('d/m/Y √† H:i') }}
                </p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                {% if audit.conformityRate is not null %}
                    {% set rate = audit.conformityRate|number_format(1) %}
                    {% if rate >= 90 %}
                        <span class="badge bg-success" style="font-size: 1.3rem; padding: 0.6rem 1.2rem;">
                            <i class="bi bi-check-circle"></i> {{ rate }}% conforme
                        </span>
                    {% elseif rate >= 70 %}
                        <span class="badge bg-info" style="font-size: 1.3rem; padding: 0.6rem 1.2rem;">
                            <i class="bi bi-info-circle"></i> {{ rate }}% conforme
                        </span>
                    {% elseif rate >= 50 %}
                        <span class="badge bg-warning" style="font-size: 1.3rem; padding: 0.6rem 1.2rem;">
                            <i class="bi bi-exclamation-triangle"></i> {{ rate }}% conforme
                        </span>
                    {% else %}
                        <span class="badge bg-danger" style="font-size: 1.3rem; padding: 0.6rem 1.2rem;">
                            <i class="bi bi-x-circle"></i> {{ rate }}% conforme
                        </span>
                    {% endif %}
                {% endif %}
                <span class="badge bg-secondary" style="font-size: 1.2rem; padding: 0.5rem 1rem;">
                    {{ audit.totalIssues }} probl√®me{% if audit.totalIssues > 1 %}s{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

{% if audit.status == 'running' %}
    <div class="alert alert-info">
        <i class="bi bi-hourglass-split"></i> L'audit est en cours d'ex√©cution...
        <div class="progress mt-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated progress-bar-full" role="progressbar"></div>
        </div>
    </div>
{% elseif audit.status == 'failed' %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> L'audit a √©chou√© : {{ audit.errorMessage }}
    </div>
{% else %}

{# Navigation par onglets #}
<ul class="nav nav-tabs mb-4" id="auditTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
            <i class="bi bi-bar-chart-fill"></i> Vue d'ensemble
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="grid-tab" data-bs-toggle="tab" data-bs-target="#grid" type="button" role="tab" aria-controls="grid" aria-selected="false">
            <i class="bi bi-clipboard-check"></i> Grille RGAA (106 crit√®res)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="false">
            <i class="bi bi-list-check"></i> D√©tail des probl√®mes
        </button>
    </li>
</ul>

<div class="tab-content" id="auditTabsContent">
    {# Tab 1 : Vue d'ensemble #}
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">

{# Summary text block - moved to top #}
{% if summary_text %}
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-card-text"></i> R√©sum√© de l'audit</h5>
    </div>
    <div class="card-body">
        <div class="text-muted">{{ summary_text }}</div>
    </div>
</div>
{% endif %}

<div class="row mb-4 stats-row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h2 class="text-danger">{{ audit.criticalCount }}</h2>
                <span class="badge severity-critical">Critiques</span>
                <small class="d-block text-muted mt-2">Bloquent l'acc√®s</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h2 class="text-warning">{{ audit.majorCount }}</h2>
                <span class="badge severity-major">Majeurs</span>
                <small class="d-block text-muted mt-2">G√™nent l'utilisation</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h2 class="text-info">{{ audit.minorCount }}</h2>
                <span class="badge severity-minor">Mineurs</span>
                <small class="d-block text-muted mt-2">Am√©liorations</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h2>{{ audit.totalIssues }}</h2>
                <span class="text-muted">Total</span>
                <small class="d-block text-muted mt-2">Tous probl√®mes</small>
            </div>
        </div>
    </div>
</div>

{# Non-conform RGAA criteria card #}
{% if non_conform_details is defined and non_conform_details|length > 0 %}
<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="bi bi-x-circle"></i> Crit√®res RGAA non-conformes
            <span class="badge bg-white text-danger ms-2">
                {{ non_conform_details|length }} non-conforme{% if non_conform_details|length > 1 %}s{% endif %}
                {% if audit.conformCriteria is not null and audit.nonConformCriteria is not null %}
                    / {{ audit.conformCriteria + audit.nonConformCriteria }} test√©s
                {% endif %}
                (sur 106 crit√®res RGAA)
            </span>
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info mb-3">
            <strong><i class="bi bi-info-circle"></i> R√©sum√© des tests :</strong>
            <div class="row mt-2 text-center">
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-success mb-0">{{ audit.conformCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res conformes<br>(aucune erreur)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-danger mb-0">{{ audit.nonConformCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res non-conformes<br>(avec erreurs)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-2 bg-white rounded">
                        <h4 class="text-secondary mb-0">{{ audit.notApplicableCriteria ?? 0 }}</h4>
                        <small class="text-muted">Crit√®res non test√©s<br>(tests manuels requis)</small>
                    </div>
                </div>
            </div>
        </div>
        <p class="text-muted mb-3">
            Chaque crit√®re non-conforme peut g√©n√©rer plusieurs erreurs individuelles.
            Cliquez sur un crit√®re ci-dessous pour voir les d√©tails des probl√®mes.
        </p>
        <div class="accordion" id="nonConformAccordion">
            {% for detail in non_conform_details %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button {% if loop.index > 3 %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.index <= 3 %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
                        <span class="badge bg-danger me-2">RGAA {{ detail.criteriaNumber }}</span>
                        <strong>{{ detail.criteriaTitle }}</strong>
                        <span class="badge bg-secondary ms-auto">{{ detail.errorCount }} erreur{% if detail.errorCount > 1 %}s{% endif %}</span>
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.index <= 3 %}show{% endif %}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#nonConformAccordion">
                    <div class="accordion-body">
                        <div style="white-space: pre-line;">{{ detail.reason }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Analyse RGAA</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="p-3 border rounded">
                    <h3 class="text-info">{{ total_themes }}</h3>
                    <span class="badge bg-info"><i class="bi bi-folder"></i> TH√àMES CONCERN√âS</span>
                    <p class="text-muted small mt-2">Sur 13 th√©matiques RGAA</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded">
                    <h3 class="text-warning">{{ total_criteria }}</h3>
                    <span class="badge bg-warning"><i class="bi bi-bookmark-check"></i> CRIT√àRES AVEC ERREURS</span>
                    <p class="text-muted small mt-2">Sur 106 crit√®res RGAA</p>
                    <p class="text-muted small mt-2">Crit√®res avec probl√®mes d√©tect√©s</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="p-3 border rounded">
                    <h3 class="text-danger">{{ audit.nonConformCriteria }}</h3>
                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> NON CONFORMES</span>
                    <p class="text-muted small mt-2">Crit√®res RGAA non respect√©s</p>
                </div>
            </div>
        </div>
    </div>
</div>

{# Tableau des crit√®res par th√©matique #}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-table"></i> D√©tail des crit√®res par th√©matique</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="criteria-status-table" class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Th√©matique RGAA</th>
                        <th class="text-center" style="width: 15%;">Conformes</th>
                        <th class="text-center" style="width: 15%;">Non conformes</th>
                        <th class="text-center" style="width: 15%;">Non test√©s</th>
                        <th class="text-center" style="width: 15%;">Non applicables</th>
                    </tr>
                </thead>
                <tbody>
                    {% for topicName, stats in criteria_status_by_topic %}
                    <tr>
                        <td><strong>{{ topicName }}</strong></td>
                        <td class="text-center">
                            <span class="badge bg-success">{{ stats.conform }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-danger">{{ stats.nonConform }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-warning">{{ stats.notTested }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ stats.notApplicable }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <th>TOTAL</th>
                        <th class="text-center">
                            <span class="badge bg-success">{{ audit.conformCriteria }}</span>
                        </th>
                        <th class="text-center">
                            <span class="badge bg-danger">{{ audit.nonConformCriteria }}</span>
                        </th>
                        <th class="text-center">
                            <span class="badge bg-warning">{{ audit.notTestedCriteria }}</span>
                        </th>
                        <th class="text-center">
                            <span class="badge bg-secondary">{{ audit.notApplicableCriteria }}</span>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

{# MASQU√â : Les statistiques RGAA automatiques ne sont pas fiables
   - Seuls ~40 crit√®res sur 106 sont testables automatiquement
   - Les autres n√©cessitent une validation manuelle
   - Ces chiffres seraient trompeurs pour l'utilisateur
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Statistiques RGAA (106 crit√®res)</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h3 class="text-success">{{ audit.conformCriteria }}</h3>
                <p class="text-muted">Conformes</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-danger">{{ audit.nonConformCriteria }}</h3>
                <p class="text-muted">Non conformes</p>
            </div>
            <div class="col-md-4">
                <h3 class="text-secondary">{{ audit.notApplicableCriteria }}</h3>
                <p class="text-muted">Non applicables</p>
            </div>
        </div>
        <div class="chart-container mt-4">
            <canvas id="criteriaChart"></canvas>
        </div>
    </div>
</div>
#}

    </div>
    {# End Tab 1: Vue d'ensemble #}

    {# Tab 2: Grille RGAA compl√®te #}
    <div class="tab-pane fade" id="grid" role="tabpanel" aria-labelledby="grid-tab">

{# Vue compl√®te des 106 crit√®res RGAA #}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Grille compl√®te RGAA 4.1 (106 crit√®res)</h5>
    </div>
    <div class="card-body">
        <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            Cette grille affiche tous les crit√®res RGAA et leur statut de v√©rification :
        </p>
        <div class="row mb-3">
            <div class="col-md-3">
                <span class="badge bg-success me-1">‚úì</span> <small>Test√© automatiquement + conforme</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-danger me-1">‚úó</span> <small>Test√© automatiquement + erreurs d√©tect√©es</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-warning me-1">‚ö†</span> <small>Non test√© (√©l√©ment absent ou v√©rification manuelle requise)</small>
            </div>
            <div class="col-md-3">
                <span class="badge bg-secondary me-1">‚ûñ</span> <small>Non v√©rifi√©</small>
            </div>
        </div>

        <div class="accordion" id="rgaaFullGridAccordion">
            {% for topic, criteria_list in criteria_by_topic %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTopic{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTopic{{ loop.index }}" aria-expanded="false" aria-controls="collapseTopic{{ loop.index }}">
                        <strong>{{ topic }}</strong>
                        <span class="ms-2 text-muted">({{ criteria_list|length }} crit√®res)</span>
                    </button>
                </h2>
                <div id="collapseTopic{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="headingTopic{{ loop.index }}" data-bs-parent="#rgaaFullGridAccordion">
                    <div class="accordion-body accordion-body-scroll">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th class="col-criteria-number">Crit√®re</th>
                                    <th class="col-criteria-level">Niveau</th>
                                    <th class="col-criteria-description">Description</th>
                                    <th class="col-criteria-status">Statut / V√©rification</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for criteria in criteria_list %}
                                <tr class="{% if not criteria.autoTestable %}manual-check-row{% endif %}" data-criteria="{{ criteria.number }}">
                                    <td><strong>{{ criteria.number }}</strong></td>
                                    <td><span class="badge bg-info">{{ criteria.level }}</span></td>
                                    <td>
                                        {{ criteria.description }}
                                        {% if not criteria.autoTestable %}
                                            <div class="mt-2">
                                                <textarea class="form-control form-control-sm manual-check-notes" placeholder="üí° Notes de v√©rification (optionnel)" rows="2" data-criteria="{{ criteria.number }}"></textarea>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if criteria.autoTestable %}
                                            {# Crit√®res test√©s automatiquement - affichage en lecture seule #}
                                            {% if criteria.number in criteria_status.conform %}
                                                <span class="badge bg-success" title="Test√© automatiquement et conforme">‚úì Conforme (auto)</span>
                                            {% elseif criteria.number in criteria_status.nonConform %}
                                                <span class="badge bg-danger" title="Test√© automatiquement et non conforme">‚úó Non conforme (auto)</span>
                                            {% else %}
                                                <span class="badge bg-warning" title="Crit√®re testable automatiquement mais non v√©rifi√© sur cette page">‚ö† Non test√© (auto)</span>
                                            {% endif %}
                                        {% else %}
                                            {# Crit√®res manuels - boutons radio interactifs #}
                                            <div class="btn-group-vertical w-100" role="group">
                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="conform_{{ criteria.number|replace({'.': '_'}) }}" value="conform" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-success" for="conform_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-check-circle"></i> Conforme
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="nonconform_{{ criteria.number|replace({'.': '_'}) }}" value="non_conform" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-danger" for="nonconform_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-x-circle"></i> Non conforme
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="notapplicable_{{ criteria.number|replace({'.': '_'}) }}" value="not_applicable" autocomplete="off">
                                                <label class="btn btn-sm btn-outline-secondary" for="notapplicable_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-dash-circle"></i> Non applicable
                                                </label>

                                                <input type="radio" class="btn-check" name="check_{{ criteria.number|replace({'.': '_'}) }}" id="notchecked_{{ criteria.number|replace({'.': '_'}) }}" value="not_checked" autocomplete="off" checked>
                                                <label class="btn btn-sm btn-outline-secondary" for="notchecked_{{ criteria.number|replace({'.': '_'}) }}">
                                                    <i class="bi bi-circle"></i> Non v√©rifi√©
                                                </label>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-3 alert alert-info">
            <h6><i class="bi bi-lightbulb"></i> Comment utiliser cette grille :</h6>
            <ul class="mb-0">
                <li><strong>Crit√®res avec badge vert/rouge "auto"</strong> : Test√©s automatiquement par les outils. Aucune action requise.</li>
                <li><strong>Crit√®res avec boutons radio</strong> : N√©cessitent une v√©rification manuelle. S√©lectionnez "Conforme" ou "Non conforme" apr√®s avoir v√©rifi√© le site.</li>
                <li><strong>Notes</strong> : Vous pouvez ajouter des observations pour chaque crit√®re manuel. Elles sont sauvegard√©es automatiquement.</li>
            </ul>
        </div>
    </div>
</div>

    </div>
    {# End Tab 2: Grille RGAA #}

    {# Tab 3: D√©tail des probl√®mes #}
    <div class="tab-pane fade" id="details" role="tabpanel" aria-labelledby="details-tab">
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> D√©tail des probl√®mes d√©tect√©s</h5>
    </div>
    <div class="card-body">
        {% if grouped_by_theme|length > 0 %}
        {% for key, theme in grouped_by_theme %}
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header theme-card-header" style="background-color: {{ theme.theme_color }}15; border-left-color: {{ theme.theme_color }};">
                <h4 class="mb-0">
                    <i class="{{ theme.theme_icon }}" style="color: {{ theme.theme_color }};"></i>
                    <strong>Th√®me {{ theme.theme_number }}</strong> : {{ theme.theme_name }}
                    <span class="badge bg-secondary ms-2">{{ theme.total_count }} probl√®me(s)</span>
                </h4>
            </div>
            <div class="card-body">
                {% for criterion_key, criterion_data in theme.criteria %}
                {% set safe_criterion_key = criterion_key|replace({'.': '_', ',': '_', ' ': '_', ':': '_'}) %}
                <div class="mb-4">
                    <h5 class="border-bottom pb-2 mb-3">
                        <i class="bi bi-bookmark-check" style="color: {{ theme.theme_color }};"></i>
                        Crit√®re <strong>{{ criterion_data.criterion }}</strong>{% if criterion_data.criterion_description and criterion_data.criterion_description != '' %} - {{ criterion_data.criterion_description }}{% endif %}
                        <span class="badge bg-secondary ms-2">{{ criterion_data.total_count }}</span>
                    </h5>

                {% if criterion_data.results.critical|length > 0 %}
                <h6 class="mt-2"><span class="badge severity-critical">Probl√®mes critiques ({{ criterion_data.results.critical|length }} types)</span></h6>
                <div class="accordion mb-3" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_critical">
                    {{ macros.issueAccordion(criterion_data.results.critical, 'critical', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_critical') }}
                </div>
                {% endif %}

                {% if criterion_data.results.major|length > 0 %}
                <h6 class="mt-3"><span class="badge severity-major">Probl√®mes majeurs ({{ criterion_data.results.major|length }} types)</span></h6>
                <div class="accordion mb-3" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_major">
                    {{ macros.issueAccordion(criterion_data.results.major, 'major', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_major') }}
                </div>
                {% endif %}

                {% if criterion_data.results.minor|length > 0 %}
                <h6 class="mt-3"><span class="badge severity-minor">Probl√®mes mineurs ({{ criterion_data.results.minor|length }} types)</span></h6>
                <div class="accordion" id="accordion_{{ theme.theme_number }}_{{ safe_criterion_key }}_minor">
                    {{ macros.issueAccordion(criterion_data.results.minor, 'minor', theme.theme_number, safe_criterion_key, 'accordion_' ~ theme.theme_number ~ '_' ~ safe_criterion_key ~ '_minor') }}
                </div>
                {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i> Aucun probl√®me d√©tect√© !
        </div>
        {% endif %}
    </div>
</div>

    </div>
    {# End Tab 3: D√©tail des probl√®mes #}

</div>
{# End tab-content #}

{% endif %}
{% endblock %}

{% block javascripts %}
{% if audit.status == 'completed' %}
<script>
// Manual checks JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const auditId = {{ audit.id }};
    const manualChecks = {{ manual_checks|json_encode|raw }};
    const criteriaByTopic = {{ criteria_by_topic|json_encode|raw }};
    const criteriaStatus = {{ criteria_status|json_encode|raw }};

    // Load existing checks
    Object.keys(manualChecks).forEach(criteriaNumber => {
        const check = manualChecks[criteriaNumber];
        const safeNumber = criteriaNumber.replace(/\./g, '_');

        // Set radio button
        const radioButton = document.querySelector(`input[name="check_${safeNumber}"][value="${check.status}"]`);
        if (radioButton) {
            radioButton.checked = true;
        }

        // Set notes
        const notesTextarea = document.querySelector(`.manual-check-notes[data-criteria="${criteriaNumber}"]`);
        if (notesTextarea && check.notes) {
            notesTextarea.value = check.notes;
        }
    });

    // Save function
    function saveManualCheck(criteriaNumber, status, notes) {
        console.log('saveManualCheck called:', { criteriaNumber, status, notes });

        // Update local manualChecks object
        manualChecks[criteriaNumber] = { status: status, notes: notes };

        // Update table immediately (optimistic update)
        updateCriteriaStatusTable();

        // Save to server
        fetch(`/manual-check/save/${auditId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                criteriaNumber: criteriaNumber,
                status: status,
                notes: notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Saved:', criteriaNumber, status);
                showToast('‚úì V√©rification sauvegard√©e', 'success');
            } else {
                showToast('‚úó Erreur de sauvegarde', 'danger');
                // Revert on error (optional - you could reload instead)
                delete manualChecks[criteriaNumber];
                updateCriteriaStatusTable();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('‚úó Erreur de sauvegarde', 'danger');
            // Revert on error
            delete manualChecks[criteriaNumber];
            updateCriteriaStatusTable();
        });
    }

    // Toast notification
    function showToast(message, type) {
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        const toastElement = document.createElement('div');
        toastElement.innerHTML = toastHtml;
        document.body.appendChild(toastElement);
        const toast = new bootstrap.Toast(toastElement.querySelector('.toast'));
        toast.show();
        setTimeout(() => toastElement.remove(), 4000);
    }

    // Update criteria status table in real-time
    function updateCriteriaStatusTable() {
        let totalConform = 0;
        let totalNonConform = 0;
        let totalNotApplicable = 0;
        let totalNotTested = 0;

        // Get current table rows (excluding header and footer)
        const table = document.getElementById('criteria-status-table');
        if (!table) {
            console.error('Table #criteria-status-table not found');
            return;
        }
        const tableBody = table.querySelector('tbody');
        const rows = tableBody.querySelectorAll('tr');

        rows.forEach((row, index) => {
            const topicName = Object.keys(criteriaByTopic)[index];
            const topicCriteria = criteriaByTopic[topicName];

            let conformCount = 0;
            let nonConformCount = 0;
            let notApplicableCount = 0;
            let notTestedCount = 0;

            topicCriteria.forEach(criterion => {
                const criterionNumber = criterion.number;

                // Priority 1: Check if not applicable (from manual checks)
                if (manualChecks[criterionNumber] && manualChecks[criterionNumber].status === 'not_applicable') {
                    notApplicableCount++;
                }
                // Priority 2: Check if non-conform (from automatic tests)
                else if (criteriaStatus.nonConform && criteriaStatus.nonConform.includes(criterionNumber)) {
                    nonConformCount++;
                }
                // Priority 3: Check if conform (from automatic tests OR manual checks)
                else if ((criteriaStatus.conform && criteriaStatus.conform.includes(criterionNumber)) ||
                         (manualChecks[criterionNumber] && manualChecks[criterionNumber].status === 'conform')) {
                    conformCount++;
                }
                // Priority 4: Not tested yet
                else {
                    notTestedCount++;
                }
            });

            // Update row badges
            row.children[1].querySelector('.badge').textContent = conformCount;
            row.children[2].querySelector('.badge').textContent = nonConformCount;
            row.children[3].querySelector('.badge').textContent = notTestedCount;
            row.children[4].querySelector('.badge').textContent = notApplicableCount;

            // Add to totals
            totalConform += conformCount;
            totalNonConform += nonConformCount;
            totalNotApplicable += notApplicableCount;
            totalNotTested += notTestedCount;
        });

        // Update footer totals
        const footerRow = table.querySelector('tfoot tr');
        footerRow.children[1].querySelector('.badge').textContent = totalConform;
        footerRow.children[2].querySelector('.badge').textContent = totalNonConform;
        footerRow.children[3].querySelector('.badge').textContent = totalNotTested;
        footerRow.children[4].querySelector('.badge').textContent = totalNotApplicable;

        console.log('Table updated:', { totalConform, totalNonConform, totalNotTested, totalNotApplicable });
    }

    // Listen to radio buttons
    document.querySelectorAll('input[type="radio"][name^="check_"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const row = this.closest('tr.manual-check-row');
            const criteriaNumber = row.dataset.criteria;
            const status = this.value;
            const notesElement = document.querySelector(`.manual-check-notes[data-criteria="${criteriaNumber}"]`);
            const notes = notesElement ? notesElement.value : '';

            saveManualCheck(criteriaNumber, status, notes);
        });
    });

    // Listen to notes textarea (debounced)
    let noteTimeout;
    document.querySelectorAll('.manual-check-notes').forEach(textarea => {
        textarea.addEventListener('input', function() {
            clearTimeout(noteTimeout);
            noteTimeout = setTimeout(() => {
                const criteriaNumber = this.dataset.criteria;
                const safeNumber = criteriaNumber.replace(/\./g, '_');
                const radioButton = document.querySelector(`input[name="check_${safeNumber}"]:checked`);
                const status = radioButton ? radioButton.value : 'not_checked';
                const notes = this.value;

                saveManualCheck(criteriaNumber, status, notes);
            }, 1000); // Wait 1s after user stops typing
        });
    });
});
</script>
{% endif %}
{% endblock %}
