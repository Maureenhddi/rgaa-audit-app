{% extends 'base.html.twig' %}

{% block title %}Auditer une page - {{ parent() }}{% endblock %}

{% block content %}
{# Duplicate Detection Modal #}
{% if existing_audit is defined %}
<div class="modal fade show" id="duplicateModal" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);" aria-modal="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill"></i> Page d√©j√† audit√©e
                </h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-4">
                    <strong>‚ö†Ô∏è URL d√©j√† audit√©e dans cette campagne :</strong>
                    <p class="mb-0 mt-2"><code>{{ duplicate_url }}</code></p>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <strong>üìä Audit existant</strong>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Date :</dt>
                            <dd class="col-sm-8">{{ existing_audit.createdAt|date('d/m/Y √† H:i') }}</dd>

                            <dt class="col-sm-4">Type de page :</dt>
                            <dd class="col-sm-8">
                                {% if existing_audit.pageType == 'homepage' %}Accueil
                                {% elseif existing_audit.pageType == 'form' %}Formulaire
                                {% elseif existing_audit.pageType == 'listing' %}Liste
                                {% elseif existing_audit.pageType == 'article' %}Article
                                {% else %}Autre
                                {% endif %}
                            </dd>

                            <dt class="col-sm-4">Conformit√© :</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-primary">{{ existing_audit.conformityRate ?? 0 }}%</span>
                            </dd>

                            <dt class="col-sm-4">Probl√®mes d√©tect√©s :</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-danger">{{ existing_audit.criticalIssues ?? 0 }} critiques</span>
                                <span class="badge bg-warning text-dark">{{ existing_audit.majorIssues ?? 0 }} majeurs</span>
                                <span class="badge bg-info">{{ existing_audit.minorIssues ?? 0 }} mineurs</span>
                            </dd>
                        </dl>
                    </div>
                </div>

                <p class="mb-3"><strong>Que souhaitez-vous faire ?</strong></p>

                <form method="post" action="{{ path('app_audit_new', {campaign_id: campaign.id}) }}" id="duplicate-form">
                    <input type="hidden" name="url" value="{{ duplicate_url }}">
                    <input type="hidden" name="page_type" value="{{ page_type }}">
                    <input type="hidden" name="audit_scope" value="{{ audit_scope|default('full') }}">
                    <input type="hidden" name="duplicate_action" id="duplicate_action" value="">
                    {% if image_analysis_types is defined %}
                        {% for type in image_analysis_types %}
                            <input type="hidden" name="image_analysis_types[]" value="{{ type }}">
                        {% endfor %}
                    {% endif %}

                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-warning btn-lg" onclick="document.getElementById('duplicate_action').value='replace';">
                            <i class="bi bi-arrow-repeat"></i> Remplacer l'audit pr√©c√©dent
                            <small class="d-block mt-1" style="font-size: 0.85rem;">L'ancien audit sera supprim√© et un nouveau sera cr√©√©</small>
                        </button>

                        <button type="submit" class="btn btn-info btn-lg" onclick="document.getElementById('duplicate_action').value='create_new';">
                            <i class="bi bi-plus-circle"></i> Cr√©er un nouvel audit (suivi temporel)
                            <small class="d-block mt-1" style="font-size: 0.85rem;">Les deux audits coexisteront (utile pour suivre les am√©liorations)</small>
                        </button>

                        <a href="{{ path('app_campaign_show', {id: campaign.id}) }}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Breadcrumb #}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ path('app_project_list') }}">Projets</a></li>
        <li class="breadcrumb-item"><a href="{{ path('app_project_show', {id: campaign.project.id}) }}">{{ campaign.project.name }}</a></li>
        <li class="breadcrumb-item"><a href="{{ path('app_campaign_show', {id: campaign.id}) }}">{{ campaign.name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Auditer une page</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-lg-8">
        {# Campaign Info Card #}
        <div class="card mb-4 shadow-sm" style="border-left: 4px solid {{ campaign.project.color }};">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-clipboard-data"></i> {{ campaign.name }}
                </h5>
                <p class="text-muted mb-2">
                    <i class="bi bi-folder"></i> Projet : {{ campaign.project.name }}
                </p>
                {% if campaign.description %}
                    <p class="mb-0"><small>{{ campaign.description }}</small></p>
                {% endif %}
                <div class="mt-3">
                    <span class="badge bg-info">{{ campaign.totalPages ?? 0 }} page(s) d√©j√† audit√©e(s)</span>
                    {% if campaign.avgConformityRate %}
                        <span class="badge bg-primary">Conformit√© moyenne : {{ campaign.avgConformityRate }}%</span>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Form Card #}
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Auditer une nouvelle page
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Ajoutez une page √† auditer</strong>
                    <p class="mb-0 mt-2">
                        Chaque page sera audit√©e individuellement. Les r√©sultats seront agr√©g√©s dans la campagne
                        pour obtenir une vue d'ensemble de la conformit√© du site.
                    </p>
                </div>

                <form method="post" action="{{ path('app_audit_new', {campaign_id: campaign.id}) }}" id="audit-form">
                    <input type="hidden" name="campaign_id" value="{{ campaign.id }}">

                    {# URL Input #}
                    <div class="mb-4">
                        <label for="url" class="form-label">
                            <i class="bi bi-link-45deg"></i> <strong>URL de la page √† auditer</strong>
                        </label>
                        <input type="url"
                               class="form-control form-control-lg"
                               id="url"
                               name="url"
                               placeholder="https://example.com/page"
                               required
                               autofocus>
                        <small class="text-muted">
                            Entrez l'URL compl√®te de la page (ex: https://{{ campaign.project.name|lower|replace({' ': '-'}) }}.com/contact)
                        </small>
                    </div>

                    {# Page Type Selection #}
                    <div class="mb-4">
                        <label for="page_type" class="form-label">
                            <i class="bi bi-tags"></i> <strong>Type de page</strong>
                        </label>
                        <select class="form-select" id="page_type" name="page_type" required>
                            <option value="homepage">Accueil</option>
                            <option value="form">Formulaire (contact, inscription, etc.)</option>
                            <option value="listing">Liste / Catalogue (produits, articles, etc.)</option>
                            <option value="article">Article / Page de contenu</option>
                            <option value="other" selected>Autre</option>
                        </select>
                        <small class="text-muted">
                            Indiquez le type de page pour faciliter l'organisation et l'analyse
                        </small>
                    </div>

                    {# Audit Scope Selection #}
                    <div class="mb-4">
                        <label for="audit_scope" class="form-label">
                            <i class="bi bi-bounding-box"></i> <strong>P√©rim√®tre de l'audit</strong>
                        </label>
                        <select class="form-select" id="audit_scope" name="audit_scope" required>
                            <option value="full" selected>Page compl√®te</option>
                            <option value="transverse">√âl√©ments transverses uniquement</option>
                            <option value="main_content">Contenu principal uniquement</option>
                        </select>
                        <div id="scope-description" class="mt-2 p-3 bg-light rounded small">
                            <i class="bi bi-info-circle text-primary"></i>
                            <span id="scope-text">Audite l'int√©gralit√© de la page (header, navigation, contenu, footer)</span>
                        </div>
                    </div>

                    {# Deep Image Analysis Options #}
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-robot"></i> <strong>Analyses IA des images (optionnel)</strong>
                        </label>
                        <p class="text-muted small mb-3">
                            S√©lectionnez les crit√®res RGAA √† v√©rifier par intelligence artificielle sur toutes les images de la page.
                        </p>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check p-3 border rounded">
                                    <input class="form-check-input" type="checkbox" id="ia_alt_relevance" name="image_analysis_types[]" value="alt-relevance">
                                    <label class="form-check-label" for="ia_alt_relevance">
                                        <strong><i class="bi bi-check2-square"></i> Pertinence des alt (RGAA 1.3)</strong>
                                        <small class="d-block text-muted mt-1">
                                            V√©rifie si l'attribut alt d√©crit correctement le contenu de l'image
                                        </small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check p-3 border rounded">
                                    <input class="form-check-input" type="checkbox" id="ia_decorative" name="image_analysis_types[]" value="decorative-detection">
                                    <label class="form-check-label" for="ia_decorative">
                                        <strong><i class="bi bi-palette"></i> Images d√©coratives (RGAA 1.2)</strong>
                                        <small class="d-block text-muted mt-1">
                                            D√©tecte si les images d√©coratives ont bien alt="" ou role="presentation"
                                        </small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check p-3 border rounded">
                                    <input class="form-check-input" type="checkbox" id="ia_text_image" name="image_analysis_types[]" value="text-in-image">
                                    <label class="form-check-label" for="ia_text_image">
                                        <strong><i class="bi bi-fonts"></i> Texte dans images (RGAA 8.9)</strong>
                                        <small class="d-block text-muted mt-1">
                                            D√©tecte si du texte est pr√©sent dans l'image
                                        </small>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-check p-3 border rounded">
                                    <input class="form-check-input" type="checkbox" id="ia_contrast" name="image_analysis_types[]" value="text-contrast">
                                    <label class="form-check-label" for="ia_contrast">
                                        <strong><i class="bi bi-circle-half"></i> Contraste texte (RGAA 3.2)</strong>
                                        <small class="d-block text-muted mt-1">
                                            V√©rifie le contraste des textes dans les images (‚â•4.5:1)
                                        </small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3 mb-0" style="font-size: 0.9rem;">
                            <i class="bi bi-clock"></i> <strong>Dur√©e :</strong> +20-60 secondes par type d'analyse s√©lectionn√©
                        </div>
                    </div>

                    {# Submit Button #}
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{{ path('app_campaign_show', {id: campaign.id}) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Annuler
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                            <i class="bi bi-play-circle"></i> Lancer l'audit
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {# Progress Section (hidden by default) #}
        <div id="audit-progress" class="card mt-4 shadow-sm" style="display: none; background: linear-gradient(135deg, var(--primary-color) 0%, var(--info-color) 100%); color: white;">
            <div class="card-body">
                <h5><i class="bi bi-hourglass-split"></i> Analyse en cours...</h5>
                <p class="mb-3">L'audit peut prendre 2-5 minutes. Veuillez patienter.</p>

                <div class="progress mb-3" style="height: 30px; border-radius: 15px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>

                <div class="step-item mb-2 p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                    <strong>√âtape 1/3</strong> - Analyse Playwright (Axe-core + A11yLint RGAA)
                </div>
                <div class="step-item mb-2 p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                    <strong>√âtape 2/3</strong> - Analyse IA Gemini (recommandations)
                </div>
                <div class="step-item p-3 rounded" style="background: rgba(255, 255, 255, 0.1);">
                    <strong>√âtape 3/3</strong> - Calcul des statistiques et g√©n√©ration du rapport
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('audit-form');
    const submitBtn = document.getElementById('submit-btn');
    const progressDiv = document.getElementById('audit-progress');
    const auditScopeSelect = document.getElementById('audit_scope');
    const scopeText = document.getElementById('scope-text');

    // Audit scope descriptions
    const scopeDescriptions = {
        'full': "Audite l'int√©gralit√© de la page (header, navigation, contenu, footer)",
        'transverse': "Audite uniquement les √©l√©ments transverses (header, footer, navigation, fil d'ariane). Id√©al pour auditer une seule fois les √©l√©ments communs √† toutes les pages.",
        'main_content': "Audite uniquement le contenu principal de la page (sans les √©l√©ments transverses). Id√©al pour auditer le contenu sp√©cifique √† chaque page."
    };

    // Update description when scope changes
    auditScopeSelect.addEventListener('change', function() {
        const selectedScope = this.value;
        scopeText.textContent = scopeDescriptions[selectedScope] || scopeDescriptions['full'];
    });

    form.addEventListener('submit', function(e) {
        // Disable button and show progress
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>D√©marrage...';
        progressDiv.style.display = 'block';

        // Scroll to progress
        progressDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Animate progress bar
        let progress = 0;
        const interval = setInterval(() => {
            progress += 1;
            if (progress <= 90) {
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-bar').textContent = progress + '%';
            }
        }, 1000);
    });
});
</script>
{% endblock %}
