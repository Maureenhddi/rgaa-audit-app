version: '3.8'

services:
  web:
    image: nginx:alpine
    container_name: rgaa_web_prod
    restart: always
    volumes:
      - ./public:/var/www/html/public:ro
      - ./infra/docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - php
    networks:
      - rgaa_network
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"

      # HTTP
      - "traefik.http.routers.rgaa-audit.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.rgaa-audit.entrypoints=web"
      - "traefik.http.routers.rgaa-audit.middlewares=redirect-to-https"

      # HTTPS
      - "traefik.http.routers.rgaa-audit-secure.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.rgaa-audit-secure.entrypoints=websecure"
      - "traefik.http.routers.rgaa-audit-secure.tls=true"
      - "traefik.http.routers.rgaa-audit-secure.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.rgaa-audit.loadbalancer.server.port=80"

      # Middleware redirect HTTP to HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

  php:
    build:
      context: .
      dockerfile: infra/docker/php/Dockerfile
    container_name: rgaa_php_prod
    restart: always
    volumes:
      - .:/var/www/html
      - ./infra/docker/php/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
    environment:
      APP_ENV: ${APP_ENV:-prod}
      APP_DEBUG: ${APP_DEBUG:-0}
      APP_SECRET: ${APP_SECRET}
      DATABASE_URL: "mysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db:3306/${MYSQL_DATABASE}?serverVersion=8.0"
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_API_URL: ${GEMINI_API_URL}
      NODE_SCRIPTS_PATH: ${NODE_SCRIPTS_PATH}
      NODE_EXECUTABLE: ${NODE_EXECUTABLE}
      PLAYWRIGHT_BROWSERS_PATH: ${PLAYWRIGHT_BROWSERS_PATH}
    depends_on:
      - db
    networks:
      - rgaa_network

  db:
    image: mysql:8.0
    container_name: rgaa_db_prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-rgaa_audit}
      MYSQL_USER: ${MYSQL_USER:-rgaa_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data_prod:/var/lib/mysql
    networks:
      - rgaa_network
    command: --default-authentication-plugin=mysql_native_password

volumes:
  db_data_prod:
    driver: local

networks:
  rgaa_network:
    driver: bridge
  traefik-public:
    external: true
